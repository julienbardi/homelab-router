# ------------------------------------------------------------
# EDGE CADDY â€” ROUTER (10.89.12.1)
#
# Responsibilities:
#   - TLS termination
#   - Host exposure
#   - Access policy (LAN / VPN / WAN)
#
# Non-responsibilities:
#   - Application routing
#   - Health checks
#   - Port fan-out
#
# All application logic for 10.89.12.4 is delegated to its
# local Caddy instance.
#
# DO NOT bind :80.
# DO NOT proxy via 127.0.0.1.
# ------------------------------------------------------------
{
	auto_https off
	admin off

	log {
		output file /tmp/mnt/sda/router/logs/caddy.log {
			roll_size 5MiB
			roll_keep 3
			roll_keep_for 168h
		}
		level INFO
		# Active reverse_proxy health checks may legitimately fail when
		# optional backends are offline. These failures are expected and
		# should not pollute logs or trigger operator concern.
		exclude http.handlers.reverse_proxy.health_checker.active
	}
}

# ------------------------------------------------------------
# Syncthing GUI (explicit port)
# ------------------------------------------------------------
bardi.ch:8384 {
	reverse_proxy 10.89.12.2:8384
}

# ------------------------------------------------------------
# Consolidated HTTPS listener (edge)
# ------------------------------------------------------------
:443 {
	tls {
		dns infomaniak {env.INFOMANIAK_API_TOKEN}
	}

	# --------------------------------------------------------
	# DiskStation main HTTPS site (WAN)
	# --------------------------------------------------------
	@bardi {
		host bardi.ch
	}
	reverse_proxy @bardi 10.89.12.2:443 {
		header_up Host bardi.ch
	}

	# --------------------------------------------------------
	# DSM management (internal only)
	# --------------------------------------------------------
	@syno_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @syno_internal 10.89.12.2:5001

	# --------------------------------------------------------
	# QNAP (internal only)
	# --------------------------------------------------------
	@qnap_internal {
		host qnap.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @qnap_internal 10.89.12.3:8080

	# --------------------------------------------------------
	# Router UI (internal only)
	# --------------------------------------------------------
	@router_internal {
		host router.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @router_internal 10.89.12.1:8080

	# --------------------------------------------------------
	# NAS-hosted services (delegated)
	# --------------------------------------------------------
	@nas_services {
		host \
 dns.bardi.ch \
 vpn.bardi.ch \
 derp.bardi.ch \
 dev.bardi.ch \
 apt.bardi.ch \
 nas.bardi.ch
	}

	reverse_proxy @nas_services 10.89.12.4:443

	# --------------------------------------------------------
	# Unknown host fallback
	# --------------------------------------------------------
	@unknown not host \
 bardi.ch \
 router.bardi.ch \
 dns.bardi.ch \
 vpn.bardi.ch \
 derp.bardi.ch \
 qnap.bardi.ch \
 nas.bardi.ch \
 dev.bardi.ch \
 apt.bardi.ch

	respond @unknown "Not Found" 404
}
