# ------------------------------------------------------------
# EDGE CADDY — ROUTER (10.89.12.1)
#
# This Caddy instance terminates TLS and enforces access policy.
# All backends are reached via LAN IPs — never loopback.
#
# DO NOT bind :80.
# DO NOT proxy via 127.0.0.1.
# ------------------------------------------------------------
{
	auto_https off
	admin off
}

# ------------------------------------------------------------
# Syncthing GUI (explicit port)
# ------------------------------------------------------------
bardi.ch:8384 {
	reverse_proxy 10.89.12.2:8384
}

# ------------------------------------------------------------
# Consolidated HTTPS listener (edge)
# ------------------------------------------------------------
:443 {
	# CHANGE: Swapped 'internal' for 'infomaniak'
	tls {
		dns infomaniak {env.INFOMANIAK_API_TOKEN}
	}

	# --------------------------------------------------------
	# DNS over HTTPS (public)
	# Backend moved off loopback (UGOS rule)
	# --------------------------------------------------------
	@doh {
		host dns.bardi.ch
		path /dns-query
	}
	reverse_proxy @doh https://10.89.12.4:8053 {
		transport http {
			tls
			tls_insecure_skip_verify
		}
	}

	# --------------------------------------------------------
	# DiskStation main HTTPS site (WAN)
	# --------------------------------------------------------
	@bardi_internal {
		host bardi.ch
	}
	reverse_proxy @bardi_internal 10.89.12.2:443 {
		header_up Host bardi.ch
	}

	# --------------------------------------------------------
	# DSM management (internal only)
	# --------------------------------------------------------
	@syno5001_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @syno5001_internal 10.89.12.2:5001 {
		header_up Host bardi.ch
	}

	# --------------------------------------------------------
	# Synology service (internal only)
	# --------------------------------------------------------
	@syno5006_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @syno5006_internal 10.89.12.2:5006 {
		header_up Host bardi.ch
	}

	# --------------------------------------------------------
	# Synology Drive (internal only)
	# --------------------------------------------------------
	@syno6690_internal {
		host bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @syno6690_internal 10.89.12.2:6690 {
		header_up Host bardi.ch
	}

	# --------------------------------------------------------
	# Headscale control plane (external allowed, API hidden)
	# --------------------------------------------------------
	@vpn {
		host vpn.bardi.ch
	}
	reverse_proxy @vpn 10.89.12.4:8910 {
		header_up Host vpn.bardi.ch
		header_up X-Forwarded-Proto https
	}

	# --------------------------------------------------------
	# DERP relay (external)
	# --------------------------------------------------------
	@derp {
		host derp.bardi.ch
	}
	reverse_proxy @derp 10.89.12.4:8912

	# --------------------------------------------------------
	# QNAP (internal only)
	# --------------------------------------------------------
	@qnap_internal {
		host qnap.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @qnap_internal 10.89.12.3:8080

	# --------------------------------------------------------
	# NAS internal service (internal only)
	# --------------------------------------------------------
	@nas_internal {
		host nas.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @nas_internal 10.89.12.4:9999

	# --------------------------------------------------------
	# Router UI (internal only, optional)
	# --------------------------------------------------------
	@router_internal {
		host router.bardi.ch
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
	}
	reverse_proxy @router_internal 10.89.12.1:8080

	# --------------------------------------------------------
	# Dev IDE (internal + VPN)
	# --------------------------------------------------------
	@dev_internal {
		host dev.bardi.ch

		# LAN
		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64

		# WireGuard
		remote_ip 10.0.0.0/8
		remote_ip fd89:7a3b:42c0::/48

		# Tailscale
		remote_ip 100.64.0.0/10
	}
	reverse_proxy @dev_internal 10.89.12.4:8080 {
		header_up Host dev.bardi.ch
	}

	# --------------------------------------------------------
	# apt-cacher-ng (internal only, health-gated)
	# --------------------------------------------------------
	@apt_internal {
		host apt.bardi.ch

		remote_ip 10.89.12.0/24
		remote_ip fd89:7a3b:42c0::/64
		remote_ip 10.0.0.0/8
		remote_ip fd89:7a3b:42c0::/48
		remote_ip 100.64.0.0/10
	}

	handle @apt_internal {
		# Non-blocking reverse proxy
		reverse_proxy 10.89.12.4:3142 {
			header_up Host apt.bardi.ch

			# Make health checks NON-BLOCKING
			health_uri /acng-report.html
			health_interval 10s
			health_timeout 1s
			fail_duration 0s
		}
		# If upstream is down, return 503
		@backend_down {
			expression {http.reverse_proxy.error} != ""
		}
		respond @backend_down "APT cache temporarily unavailable" 503
	}

	# --------------------------------------------------------
	# Unknown host fallback
	# --------------------------------------------------------
	@unknown not host \
 bardi.ch \
 router.bardi.ch \
 dns.bardi.ch \
 vpn.bardi.ch \
 derp.bardi.ch \
 qnap.bardi.ch \
 nas.bardi.ch \
 dev.bardi.ch \
 apt.bardi.ch

	respond @unknown "Not Found" 404
}
